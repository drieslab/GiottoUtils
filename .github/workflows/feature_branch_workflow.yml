name: Feature Branch Checks
on:
  pull_request:
    branches: [ "dev" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Setup environment
      - uses: r-lib/actions/setup-pandoc@v2
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::testthat
            any::reticulate
          needs: check
          
      - name: Create miniconda
        run: |
          reticulate::install_miniconda()
          reticulate::conda_install(packages = 'scipy')
        shell: Rscript {0}
        
      # Run unit tests
      - name: Build and install
        run: |
          R CMD build .
          R CMD INSTALL *.tar.gz
      - name: Run tests
        run: |
          library(testthat)
          library(GiottoUtils)
          test_dir("tests/testthat")
        shell: Rscript {0}

  style-bot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.STYLEBOT_TOKEN }}
          fetch-depth: 0
      
      # Setup R environment for styling
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::styler
            bioc::biocstyle
            bioc::biocthis
          needs: check
        
      # Apply style changes and create PR if needed
      - name: Apply style changes
        run: |
          # Apply style
          Rscript -e 'style_opts <- biocthis::bioc_style(indent_by = 4); styler::style_pkg(transformers = style_opts)'
          
          # Check if there are changes
          if [[ -n "$(git status --porcelain)" ]]; then
            # Configure git as bot
            git config --global user.name 'styler-bot'
            git config --global user.email '198093184+styler-bot@users.noreply.github.com'
            
            # Create and push branch
            style_branch="style/${GITHUB_HEAD_REF}/$(date +%s)"
            git checkout -b "$style_branch"
            git add .
            git commit -m "style: apply Bioconductor style guidelines"
            git push origin "$style_branch"
            
            # Create PR using GitHub CLI
            gh pr create \
              --title "style: ðŸŽ¨ automatic style fixes" \
              --body "I noticed some style issues in this PR. I've applied automatic style fixes using:
              
              ðŸ“¦ styler with Bioconductor style guidelines
              ðŸ”§ biocthis::bioc_style(indent_by = 4)
              
              Please review the changes and merge if they look good!
              
              <sub>I am a bot, and this action was performed automatically.</sub>" \
              --base "${{ github.event.pull_request.head.ref }}" \
              --head "$style_branch"
            
            # Add comment to original PR
            gh pr comment "${{ github.event.pull_request.number }}" --body "I've created a PR with style fixes: #$(gh pr list --head "$style_branch" --json number -q '.[0].number')"
          else
            echo "No style changes needed! ðŸŽ‰"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.STYLEBOT_TOKEN }}
          GITHUB_HEAD_REF: ${{ github.event.pull_request.head.ref }}