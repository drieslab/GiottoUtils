name: Feature Branch Checks
on:
  pull_request:
    branches: [ "dev" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Setup environment
      - uses: r-lib/actions/setup-pandoc@v2
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::testthat
            any::reticulate
            bioc::biocthis
            bioc::BiocStyle
          needs: check
          
      - name: Create miniconda
        run: |
          reticulate::install_miniconda()
          reticulate::conda_install(packages = 'scipy')
        shell: Rscript {0}
        
      # Run unit tests
      - name: Build and install
        run: |
          R CMD build .
          R CMD INSTALL *.tar.gz
      - name: Run tests
        run: |
          library(testthat)
          library(GiottoUtils)
          test_dir("tests/testthat")
        shell: Rscript {0}

  style-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Setup R environment for styling
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::styler
            bioc::biocthis
          needs: check
        
      # Apply style changes and commit if needed
      - name: Apply and commit style changes
        run: |
          # Configure git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Apply style
          Rscript -e 'style_opts <- biocthis::bioc_style(indent_by = 4); styler::style_pkg(transformers = style_opts)'
          
          # Check if there are changes
          if [[ -n "$(git status --porcelain)" ]]; then
            # Commit changes
            git add .
            git commit -m "style: apply bioc style guidelines"
            
            # Create branch and push
            style_branch="style-update-${GITHUB_SHA::8}"
            git checkout -b $style_branch
            git push origin $style_branch
            
            # Create PR using GitHub CLI
            gh pr create \
              --title "style: automatic style fixes" \
              --body "Applied automatic style fixes using styler with bioc guidelines.
              - Used biocthis::bioc_style with 4-space indentation
              - Applied changes through styler::style_pkg" \
              --base "${{ github.event.pull_request.head.ref }}" \
              --head "$style_branch"
          else
            echo "No style changes needed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}