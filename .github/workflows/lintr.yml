name: lintr

on:
  pull_request:
    branches: [ "dev" ]
  schedule:
    - cron: '16 20 * * 2'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  lintr:
    name: Run lintr scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/r-env
          name-canonical: true
      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run in container
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.meta.outputs.tags }}:latest
          options: -v ${{ github.workspace }}:/package
          run: |
            cd /package
            Rscript -e 'lintr::sarif_output(lintr::lint_package(".", exclusions = list("tests", "vignettes", "pkgdown"), linters = lintr::linters_with_defaults(indentation_linter = lintr::indentation_linter(indent = 4L), object_name_linter = lintr::object_name_linter(styles = c("camelCase", "symbols", "snake_case", "UPPERCASE")))), "lintr-results.sarif")'

      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: lintr-results.sarif
          wait-for-processing: true