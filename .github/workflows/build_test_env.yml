name: Weekly Environment Builder

on:
  schedule:
    - cron: '0 0 * * 0'  # Run at midnight every Sunday
  workflow_dispatch:      # Allow manual trigger

jobs:
  build-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
      
      # Set up base R
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      
      # Set up pandoc
      - uses: r-lib/actions/setup-pandoc@v2
      
      # Install all required R packages
      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::devtools
            any::remotes
            any::rcmdcheck
            any::covr
            any::testthat
            any::lintr
            any::reticulate
            any::RColorBrewer
            any::Matrix
            any::future
            any::BiocParallel
            bioc::BiocCheck
          needs: check
      
      # Set up Python environment
      - name: Setup Python environment
        run: |
          reticulate::install_miniconda()
          reticulate::conda_install(packages = 'scipy')
        shell: Rscript {0}
      
      # Create artifact of the entire environment
      - name: Package environment
        run: |
          tar -czf r-env.tar.gz \
            /opt/R \
            ${{ env.R_LIBS_USER }} \
            ~/miniconda \
            /usr/local/bin/pandoc* \
            ~/.pandoc
      
      # Upload environment artifact
      - name: Upload R environment
        uses: actions/upload-artifact@v4
        with:
          name: r-environment
          path: r-env.tar.gz
          retention-days: 7  # Keep for a week until next build